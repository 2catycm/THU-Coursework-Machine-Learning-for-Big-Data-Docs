<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans" xml:lang="zh-Hans"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="叶璨铭 (2024214500) ycm24@mails.tsinghua.edu.cn">

<title>更高效的支持向量机算法实现及其在手写数字识别中的应用——02手动实现SGD优化的软间隔线性SVM – THU-Coursework-Machine-Learning-for-Big-Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../thu_logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="更高效的支持向量机算法实现及其在手写数字识别中的应用——02手动实现SGD优化的软间隔线性SVM – THU-Coursework-Machine-Learning-for-Big-Data">
<meta property="og:description" content="大数据机器学习课程第二次实验项目">
<meta property="og:site_name" content="THU-Coursework-Machine-Learning-for-Big-Data">
<meta name="twitter:title" content="更高效的支持向量机算法实现及其在手写数字识别中的应用——02手动实现SGD优化的软间隔线性SVM – THU-Coursework-Machine-Learning-for-Big-Data">
<meta name="twitter:description" content="大数据机器学习课程第二次实验项目">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">THU-Coursework-Machine-Learning-for-Big-Data</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="搜索"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="展开或折叠导航栏" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../theory_assignments/index.html" aria-current="page"> 
<span class="menu-text">理论作业 Theory Assignments</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../coding_projects/index.html"> 
<span class="menu-text">代码项目 Coding Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.xuetangx.com/course/THU08091001026/1515437"> 
<span class="menu-text">关于课程 Course Information</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/Open-Book-Studio"> 
<span class="menu-text">关于我们 About Us</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-discuss-with-us" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">和我们一起讨论 Discuss with Us</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-discuss-with-us">    
        <li>
    <a class="dropdown-item" href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/issues"><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">你的作业有地方写错了 Report an Issue on Assignments</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="http://qm.qq.com/cgi-bin/qm/qr?wv=1027&amp;k=v0Vpqbr4pScRi4IkFK3dsDUCzvu-BtX&amp;authKey=vyojwISealVovwzm6TQR7bkawm4oj6Wgbe4YBheQjRU5XOllK9pQ57eQjaG30dlq&amp;noverify=0&amp;group_code=935310031"><i class="bi bi-chat-right-text" role="img">
</i> 
 <span class="dropdown-text">X9高校人工智能技术讨论 X9 AI Tech Discussion</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/2catycm"><i class="bi bi-question-circle" role="img">
</i> 
 <span class="dropdown-text">联系我们 Contact Us</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Open-Book-Studio"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/THU-CVML"> <i class="bi bi-github" role="img" aria-label="THU-CVML 课题组">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../coding_projects/index.html">coding_projects</a></li><li class="breadcrumb-item"><a href="../../coding_projects/P2_SVM/00svm.html">P2_SVM</a></li><li class="breadcrumb-item"><a href="../../coding_projects/P2_SVM/handy_crafted_linear.html">更高效的支持向量机算法实现及其在手写数字识别中的应用——02手动实现SGD优化的软间隔线性SVM</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">THU-Coursework-Machine-Learning-for-Big-Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../help (library information).html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Library Information</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../coding_projects/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">coding_projects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">P1_ANOVA</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/P1_ANOVA/anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">深入探索方差分析 (Analysis of Variance, ANOVA)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">P1_KNN</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/P1_KNN/kd_tree.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">深入探索KD树数据结构实现的KNN算法及其在手写数字识别中的应用</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">P2_SVM</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/P2_SVM/00svm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">更高效的支持向量机算法实现及其在手写数字识别中的应用——00绪论</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/P2_SVM/use_lib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">更高效的支持向量机算法实现及其在手写数字识别中的应用——01调库实现SVM手写数字识别</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/P2_SVM/handy_crafted_linear.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">更高效的支持向量机算法实现及其在手写数字识别中的应用——02手动实现SGD优化的软间隔线性SVM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/P2_SVM/kernel_hpo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">更高效的支持向量机算法实现及其在手写数字识别中的应用——03不同Kernel的SVM超参数优化</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/P2_SVM/handy_crafted_kernel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">更高效的支持向量机算法实现及其在手写数字识别中的应用——04手动实现使用SMO的Kernel SVM</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">big_data_analytics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">P2_Matrix-Decomposition</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../coding_projects/big_data_analytics/P2_Matrix-Decomposition/decomposition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">深入探索基于矩阵分解和协同过滤的个性化推荐系统及其在Netflix电影推荐中的应用</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../theory_assignments/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">theory_assignments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">A1</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../theory_assignments/A1/p_assignment1_yecanming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">从数据集中进行分布参数估计: 以伯努利分布为例</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">A2</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../theory_assignments/A2/p_assignment2_yecanming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">大数据机器学习课程第二次作业</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">A3</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../theory_assignments/A3/p_assignment3_yecanming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">朴素贝叶斯与决策树的深入理解</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false">
 <span class="menu-text">A4</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../theory_assignments/A4/p_assignment4_yecanming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">最大熵模型以及对数几率分类模型的深入理解</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false">
 <span class="menu-text">A5</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../theory_assignments/A5/p_assignment5_yecanming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">支持向量机的深入理解</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false">
 <span class="menu-text">A6</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../theory_assignments/A6/p_assignment6_yecanming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AdaBoost算法的深入理解</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">该页面内容</h2>
   
  <ul>
  <li><a href="#实现-hinge-losssgd-版本的-soft-margin-linear-svm" id="toc-实现-hinge-losssgd-版本的-soft-margin-linear-svm" class="nav-link active" data-scroll-target="#实现-hinge-losssgd-版本的-soft-margin-linear-svm"><span class="header-section-number">0.1</span> 实现 Hinge Loss+SGD 版本的 Soft Margin Linear SVM</a>
  <ul>
  <li><a href="#hinge-loss-二分类实现" id="toc-hinge-loss-二分类实现" class="nav-link" data-scroll-target="#hinge-loss-二分类实现"><span class="header-section-number">0.1.1</span> Hinge Loss 二分类实现</a></li>
  </ul></li>
  <li><a href="#binaryhingeloss" id="toc-binaryhingeloss" class="nav-link" data-scroll-target="#binaryhingeloss"><span class="header-section-number">0.2</span> BinaryHingeLoss</a>
  <ul>
  <li><a href="#hinge-loss-多分类实现" id="toc-hinge-loss-多分类实现" class="nav-link" data-scroll-target="#hinge-loss-多分类实现"><span class="header-section-number">0.2.1</span> Hinge Loss 多分类实现</a></li>
  </ul></li>
  <li><a href="#multiclasshingeloss" id="toc-multiclasshingeloss" class="nav-link" data-scroll-target="#multiclasshingeloss"><span class="header-section-number">0.3</span> MultiClassHingeLoss</a></li>
  <li><a href="#get_max_values_without_true" id="toc-get_max_values_without_true" class="nav-link" data-scroll-target="#get_max_values_without_true"><span class="header-section-number">0.4</span> get_max_values_without_true</a></li>
  <li><a href="#multiclasshingeloss.forward_crammer_singer" id="toc-multiclasshingeloss.forward_crammer_singer" class="nav-link" data-scroll-target="#multiclasshingeloss.forward_crammer_singer"><span class="header-section-number">0.5</span> MultiClassHingeLoss.forward_crammer_singer</a>
  <ul>
  <li><a href="#svm-模型与优化算法实现" id="toc-svm-模型与优化算法实现" class="nav-link" data-scroll-target="#svm-模型与优化算法实现"><span class="header-section-number">0.5.1</span> SVM 模型与优化算法实现</a></li>
  </ul></li>
  <li><a href="#hingesupportvectorclassifier" id="toc-hingesupportvectorclassifier" class="nav-link" data-scroll-target="#hingesupportvectorclassifier"><span class="header-section-number">0.6</span> HingeSupportVectorClassifier</a></li>
  <li><a href="#separate_weight_decay" id="toc-separate_weight_decay" class="nav-link" data-scroll-target="#separate_weight_decay"><span class="header-section-number">0.7</span> separate_weight_decay</a></li>
  <li><a href="#hingesupportvectorclassifier.configure_optimizers" id="toc-hingesupportvectorclassifier.configure_optimizers" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.configure_optimizers"><span class="header-section-number">0.8</span> HingeSupportVectorClassifier.configure_optimizers</a></li>
  <li><a href="#hingesupportvectorclassifier.test_step" id="toc-hingesupportvectorclassifier.test_step" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.test_step"><span class="header-section-number">0.9</span> HingeSupportVectorClassifier.test_step</a></li>
  <li><a href="#hingesupportvectorclassifier.validation_step" id="toc-hingesupportvectorclassifier.validation_step" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.validation_step"><span class="header-section-number">0.10</span> HingeSupportVectorClassifier.validation_step</a></li>
  <li><a href="#hingesupportvectorclassifier.on_test_epoch_end" id="toc-hingesupportvectorclassifier.on_test_epoch_end" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.on_test_epoch_end"><span class="header-section-number">0.11</span> HingeSupportVectorClassifier.on_test_epoch_end</a></li>
  <li><a href="#hingesupportvectorclassifier.on_validation_epoch_end" id="toc-hingesupportvectorclassifier.on_validation_epoch_end" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.on_validation_epoch_end"><span class="header-section-number">0.12</span> HingeSupportVectorClassifier.on_validation_epoch_end</a></li>
  <li><a href="#hingesupportvectorclassifier.on_test_epoch_start" id="toc-hingesupportvectorclassifier.on_test_epoch_start" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.on_test_epoch_start"><span class="header-section-number">0.13</span> HingeSupportVectorClassifier.on_test_epoch_start</a></li>
  <li><a href="#hingesupportvectorclassifier.on_validation_epoch_start" id="toc-hingesupportvectorclassifier.on_validation_epoch_start" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.on_validation_epoch_start"><span class="header-section-number">0.14</span> HingeSupportVectorClassifier.on_validation_epoch_start</a></li>
  <li><a href="#hingesupportvectorclassifier.on_evaluation_epoch_end" id="toc-hingesupportvectorclassifier.on_evaluation_epoch_end" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.on_evaluation_epoch_end"><span class="header-section-number">0.15</span> HingeSupportVectorClassifier.on_evaluation_epoch_end</a></li>
  <li><a href="#hingesupportvectorclassifier.evaluation_step" id="toc-hingesupportvectorclassifier.evaluation_step" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.evaluation_step"><span class="header-section-number">0.16</span> HingeSupportVectorClassifier.evaluation_step</a></li>
  <li><a href="#hingesupportvectorclassifier.on_evaluation_epoch_start" id="toc-hingesupportvectorclassifier.on_evaluation_epoch_start" class="nav-link" data-scroll-target="#hingesupportvectorclassifier.on_evaluation_epoch_start"><span class="header-section-number">0.17</span> HingeSupportVectorClassifier.on_evaluation_epoch_start</a>
  <ul>
  <li><a href="#svm-训练与评价" id="toc-svm-训练与评价" class="nav-link" data-scroll-target="#svm-训练与评价"><span class="header-section-number">0.17.1</span> SVM 训练与评价</a></li>
  </ul></li>
  <li><a href="#对手动实现的svm进行调参" id="toc-对手动实现的svm进行调参" class="nav-link" data-scroll-target="#对手动实现的svm进行调参"><span class="header-section-number">0.18</span> 对手动实现的SVM进行调参</a></li>
  <li><a href="#附加题-对比不同-kernel-方法下的-svm-分类器-对完整svm进行调参" id="toc-附加题-对比不同-kernel-方法下的-svm-分类器-对完整svm进行调参" class="nav-link" data-scroll-target="#附加题-对比不同-kernel-方法下的-svm-分类器-对完整svm进行调参"><span class="header-section-number">0.19</span> 附加题: 对比不同 kernel 方法下的 SVM 分类器 （对完整SVM进行调参）</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/issues/new" class="toc-action"><i class="bi bi-github"></i>反馈问题</a></li></ul></div><div class="quarto-alternate-formats"><h2>其他格式</h2><ul><li><a href="handy_crafted_linear.html.docx"><i class="bi bi-file-word"></i>MS Word</a></li><li><a href="handy_crafted_linear.html.md"><i class="bi bi-file-code"></i>Github (GFM)</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../coding_projects/index.html">coding_projects</a></li><li class="breadcrumb-item"><a href="../../coding_projects/P2_SVM/00svm.html">P2_SVM</a></li><li class="breadcrumb-item"><a href="../../coding_projects/P2_SVM/handy_crafted_linear.html">更高效的支持向量机算法实现及其在手写数字识别中的应用——02手动实现SGD优化的软间隔线性SVM</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">更高效的支持向量机算法实现及其在手写数字识别中的应用——02手动实现SGD优化的软间隔线性SVM</h1>
<p class="subtitle lead">大数据机器学习课程第二次实验项目</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">作者</div>
    <div class="quarto-title-meta-contents">
             <p>叶璨铭 (2024214500) ycm24@mails.tsinghua.edu.cn </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">发布于</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2024年11月11日星期一</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p><img src="../../thu_sigs_logo.png" alt="清华深研院-横" style="zoom:50%;"></p>
<p>本文是<a href="./00svm.html">更高效的支持向量机算法实现及其在手写数字识别中的应用</a>系列文章第02篇——手动实现SGD优化的软间隔线性SVM。</p>
<div id="cell-4" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dataset_dict_uci_digits <span class="op">=</span> load_digits(as_frame<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>X_train, X_val, X_test, y_train, y_val, y_test, train_set, val_set, test_set, data_module, categories <span class="op">=</span> process_sklearn_dataset_dict(dataset_dict_uci_digits, <span class="st">'all'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>dataset_dict_full_mnist <span class="op">=</span> fetch_openml(<span class="st">"mnist_784"</span>, as_frame<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>X_train_full, X_val_full, X_test_full, y_train_full, y_val_full, y_test_full, train_set_full, val_set_full, test_set_full, data_module_full, categories_full <span class="op">=</span> process_sklearn_dataset_dict(dataset_dict_full_mnist, <span class="st">'all'</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(1797, 64) float32 (1797,) int64 [0 1 2 3 4 5 6 7 8 9]
1293 144 360
(70000, 784) float32 (70000,) int64 [0 1 2 3 4 5 6 7 8 9]
50400 5600 14000</code></pre>
</div>
</div>
<section id="实现-hinge-losssgd-版本的-soft-margin-linear-svm" class="level3" data-number="0.1">
<h3 data-number="0.1" class="anchored" data-anchor-id="实现-hinge-losssgd-版本的-soft-margin-linear-svm"><span class="header-section-number">0.1</span> 实现 Hinge Loss+SGD 版本的 Soft Margin Linear SVM</h3>
<p>我们现在来实现与<code>from sklearn.linear_model import SGDClassifier</code>等价的 SVM，但是我们基于PyTorch实现，在GPU上面运行，期望能在大型数据集上比sklearn的实现快。</p>
<section id="hinge-loss-二分类实现" class="level4" data-number="0.1.1">
<h4 data-number="0.1.1" class="anchored" data-anchor-id="hinge-loss-二分类实现"><span class="header-section-number">0.1.1</span> Hinge Loss 二分类实现</h4>
<p>首先回顾二分类情况下，李航《统计学习方法》131页的优化目标：</p>
<p><span class="math display">\[
\min_{w, b} \sum_{i=1}^N \left[ 1 - y_i(w \cdot x_i + b) \right]_+ + \lambda \lVert w \rVert^2
\]</span></p>
<p>李航随即给出了证明，证明这个无约束最优化问题等价于优化软间隔线性支持向量机的原始问题。我感觉上面的式子有点丑，莫名其妙地引入了没有物理意义的超参数<span class="math inline">\(\lambda\)</span>, 让读者无法与软间隔问题中的<span class="math inline">\(C\)</span>联系起来。所以我们使用李航证明中用来说明这两个问题等效性的式子:</p>
<p><span class="math display">\[
\min_{w, b}  \frac{1}{2} \lVert w \rVert^2 + C \sum_{i=1}^N \left[ 1 - y_i(w \cdot x_i + b) \right]_+
\]</span></p>
<p>其中 $<em>i = </em>+ $ 是松弛变量，<span class="math inline">\([]_+\)</span> 自动地让松弛变量满足了约束。</p>
<p>我们现在就可以用 PyTorch 实现这个 二分类情况下的 Hinge Loss了。</p>
<p>注意，在下面的代码中我们不会去实现<span class="math inline">\(\frac{1}{2} \lVert w \rVert^2\)</span>!</p>
<p>因为在实际PyTorch项目中，这个是写在 Optimizer的 weight decay里面的。 1/2 其实和 C 、学习率等 只是相对比例关系。</p>
<p>这是因为 PyTorch 的设计哲学中，loss 函数的输入就是 logits 和 labels，不会包括模型的参数，这样才能把逻辑解耦开来。</p>
<p>所以如果我们在loss就实现 l2 regularization，是很麻烦而且没有必要的。</p>
<p>Optimizer 有权限访问到 model 的参数，所以我们待会可以精确控制，只对 weight 而非 bias 做 l2 regularization，从而满足 SVM 的要求。</p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L19" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="binaryhingeloss" class="level3" data-number="0.2">
<h3 data-number="0.2" class="anchored" data-anchor-id="binaryhingeloss"><span class="header-section-number">0.2</span> BinaryHingeLoss</h3>
<blockquote class="blockquote">
<pre><code> BinaryHingeLoss (C=1.0, squared=False, margin=1.0)</code></pre>
</blockquote>
<p><em>Binary Hinge Loss. For SVM, <span class="math display">\[
\min_{w, b}  rac{1}{2} \lVert w Vert^2 + C \sum_{i=1}^N \left[ 1 - y_i(w \cdot x_i + b) ight]_+
\]</span> we compute <span class="math display">\[
C \sum_{i=1}^N \left[ 1 - y_i(w \cdot x_i + b) ight]_+
\]</span></em></p>
<div id="cell-8" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> store_attr</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-9" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BinaryHingeLoss(nn.Module):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Binary Hinge Loss. </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    For SVM, </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    $$</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    \min_{w, b}  </span><span class="ch">\f</span><span class="co">rac{1}{2} \lVert w </span><span class="ch">\r</span><span class="co">Vert^2 + C \sum_{i=1}^N \left[ 1 - y_i(w \cdot x_i + b) </span><span class="ch">\r</span><span class="co">ight]_+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    $$</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    we compute </span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    $$</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    C \sum_{i=1}^N \left[ 1 - y_i(w \cdot x_i + b) </span><span class="ch">\r</span><span class="co">ight]_+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    $$</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, C<span class="op">=</span><span class="fl">1.0</span>, </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                 squared <span class="op">=</span> <span class="va">False</span>, </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                 margin <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        store_attr() <span class="co"># 保存参数到实例变量中</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, y_pred_logits:torch.Tensor, y_true:torch.Tensor)<span class="op">-&gt;</span>torch.Tensor:</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        functional_margin <span class="op">=</span> y_true <span class="op">*</span> y_pred_logits <span class="co"># 函数间隔</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        how_small_than_required_margin <span class="op">=</span> <span class="va">self</span>.margin <span class="op">-</span> functional_margin</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        xi <span class="op">=</span> torch.clamp(how_small_than_required_margin, <span class="bu">min</span><span class="op">=</span><span class="dv">0</span>) <span class="co"># 计算 xi 也就是 松弛变量</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.squared:</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            xi <span class="op">=</span> xi <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.C <span class="op">*</span> xi.<span class="bu">sum</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>其中 <code>squared</code> 参数表示是否使用 squared hinge loss。 什么叫做 squared hinge loss 呢？我们做过理论作业，李航《统计学习方法》153页例题 7.3 提到了 (但是书上没有给出Reference) <span class="math display">\[
\min_{w, b}  \frac{1}{2} \lVert w \rVert^2 + C \sum_{i=1}^N \xi_i^2
\]</span> 来取代 <span class="math display">\[
\min_{w, b}  \frac{1}{2} \lVert w \rVert^2 + C \sum_{i=1}^N \xi_i
\]</span> 其实上面那个式子就是 squared hinge loss。</p>
<div id="cell-11" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.test <span class="im">import</span> test_eq</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 尝试一下</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>critierion <span class="op">=</span> BinaryHingeLoss(margin<span class="op">=</span><span class="dv">1</span>, C<span class="op">=</span><span class="dv">1</span>, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>y_pred_logits <span class="op">=</span> torch.tensor([<span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">3.0</span>], requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> torch.tensor([<span class="fl">1.0</span>, <span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.0</span>])</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>test_eq(critierion(y_pred_logits, y_true).item(), <span class="dv">1</span><span class="op">-</span>(<span class="op">-</span><span class="fl">1.0</span>)<span class="op">*</span><span class="fl">2.0</span>) <span class="co"># 第二个样本分类错误，函数间隔为 -2， 差了 3</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="hinge-loss-多分类实现" class="level4" data-number="0.2.1">
<h4 data-number="0.2.1" class="anchored" data-anchor-id="hinge-loss-多分类实现"><span class="header-section-number">0.2.1</span> Hinge Loss 多分类实现</h4>
<p>现在我们已经成功实现 BinaryHingeLoss， 接下来我们要考虑 多分类情况下 要如何变化。</p>
<p>参考</p>
<ul>
<li>https://lightning.ai/docs/torchmetrics/stable/classification/hinge_loss.html</li>
<li>https://pytorch.org/docs/stable/generated/torch.nn.MultiMarginLoss.html</li>
</ul>
<p>按照我们上文 理论回顾 一节说的，有两类方法。首先是直接法，具体来说 <a href="https://jmlr.csail.mit.edu/papers/volume2/crammer01a/crammer01a.pdf">Crammer and Singer在论文中</a> 提出， 对于每一个样本$x_i, y_i, t_i $ (y_i 是 one hot vector, t_i 是 标签，假如是第k类也就是$t_i = k <span class="math inline">\(，\)</span>y_i^{t_i} = 1, y_i^{k!=t_i} = 0<span class="math inline">\(), 使用这一个公式来作为 多分类的 Hinge Loss\)</span>$ L_i = _+ $$ 其中 <span class="math inline">\(\hat{y_i}^k = (w^k \cdot x_i + b^k)\)</span> 是针对第k个类的那一个SVM(<span class="math inline">\(w^k, b^k\)</span>表示)预测出来的值，不是函数间隔哦，没有乘<span class="math inline">\(y_i^k\)</span>。</p>
<p>而间接法则是使用 one vs all(a.k.a., rest) 来计算 hinge loss。（one vs one 比较少见）</p>
<p>具体而言，首先 $t_i = k <span class="math inline">\(，\)</span>y_i^{t_i} = 1, y_i^{k!=t_i} = -1$, <span class="math inline">\(\hat{y_i}^k = (w^k \cdot x_i + b^k)\)</span> 表示 是否为 第k个类。 对于每一个样本i，对于每一个样本k都能计算出一个binary loss：</p>
<p><span class="math display">\[L_i^k = \left[ 1 - y_i^k (w^k \cdot x_i + b^k) \right]_+ \]</span></p>
<p>相当于同时在训练K个分类器，所以这些loss都可以加在一起，反向传播训练对于<span class="math inline">\(w^k, b^k\)</span>独立操作。</p>
<p>所以推导一下，如果每一个 <span class="math inline">\(1 - y_i^k (w^k \cdot x_i + b^k)\)</span> 都 <span class="math inline">\(\gt 0\)</span> 就相当于</p>
<p><span class="math display">\[L_i = \sum_{k=1}^{K} L_i^k \approx \left[ K - (\hat{y_i}^{t_i} - \sum_{k \neq t_i} \hat{y_i}^k)) \right]_+ \]</span></p>
<p>但是并不是都&gt;0的，没法这样进去推导，所以还是得老老实实相加。</p>
<p>理论清晰之后，现在我们开始实现代码：</p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L53" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="multiclasshingeloss" class="level3" data-number="0.3">
<h3 data-number="0.3" class="anchored" data-anchor-id="multiclasshingeloss"><span class="header-section-number">0.3</span> MultiClassHingeLoss</h3>
<blockquote class="blockquote">
<pre><code> MultiClassHingeLoss (C=1.0, squared=False, margin=1.0,
                      strategy:Literal['crammer_singer','one_vs_all']='cra
                      mmer_singer')</code></pre>
</blockquote>
<p><em>MultiClassHingeLoss</em></p>
<div id="cell-16" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> patch</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Literal</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-17" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Strategy <span class="op">=</span> Literal[<span class="st">'crammer_singer'</span>, <span class="st">'one_vs_all'</span>]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiClassHingeLoss(nn.Module):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""MultiClassHingeLoss"""</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, C<span class="op">=</span><span class="fl">1.0</span>, </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                 squared <span class="op">=</span> <span class="va">False</span>, </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                 margin <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                 strategy: Strategy <span class="op">=</span> <span class="st">'crammer_singer'</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                <span class="co">#  *args, **kwargs</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        store_attr()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.binary_critieria <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, y_pred_logits:torch.Tensor, </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                y_true:torch.Tensor <span class="co"># 并非 one hot 编码，而是 int/long 类型 的 label</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                )<span class="op">-&gt;</span>torch.Tensor:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.strategy <span class="op">==</span> <span class="st">'crammer_singer'</span>:</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.forward_crammer_singer(y_pred_logits, y_true)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.strategy <span class="op">==</span> <span class="st">'one_vs_all'</span>:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.forward_one_vs_all(y_pred_logits, y_true)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid strategy: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>strategy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward_one_vs_all(<span class="va">self</span>, y_pred_logits:torch.Tensor, y_true:torch.Tensor)<span class="op">-&gt;</span>torch.Tensor:</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        num_of_classes <span class="op">=</span> y_pred_logits.size(<span class="dv">1</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.binary_critieria <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.binary_critieria <span class="op">=</span> nn.ModuleList([</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                BinaryHingeLoss(C<span class="op">=</span><span class="va">self</span>.C, squared<span class="op">=</span><span class="va">self</span>.squared, margin<span class="op">=</span><span class="va">self</span>.margin)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_of_classes)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                ])</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        losses <span class="op">=</span> []</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k, critierion <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.binary_critieria):</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            y_true_binary <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (y_true <span class="op">==</span> k) <span class="op">-</span> <span class="dv">1</span> <span class="co"># 转换为 -1/1 编码、</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>            y_pred_that_class <span class="op">=</span> y_pred_logits[:, k]</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> critierion(y_pred_that_class, y_true_binary)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            losses.append(loss)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>(losses)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward_crammer_singer(<span class="va">self</span>, y_pred_logits:torch.Tensor, y_true:torch.Tensor)<span class="op">-&gt;</span>torch.Tensor: ...</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L93" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_max_values_without_true" class="level3" data-number="0.4">
<h3 data-number="0.4" class="anchored" data-anchor-id="get_max_values_without_true"><span class="header-section-number">0.4</span> get_max_values_without_true</h3>
<blockquote class="blockquote">
<pre><code> get_max_values_without_true (y_pred_logits, y_true)</code></pre>
</blockquote>
<p>*获取去掉y_true对应元素后，y_pred_logits每行的最大值。</p>
<p>参数: y_pred_logits: torch.Tensor, 形状为 (N, K) y_true: torch.Tensor, 形状为 (N,)</p>
<p>返回: torch.Tensor, 形状为 (N,), 去掉y_true对应元素后每行的最大值*</p>
<div id="cell-19" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-20" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_max_values_without_true(y_pred_logits, y_true):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    获取去掉y_true对应元素后，y_pred_logits每行的最大值。</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    参数:</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    y_pred_logits: torch.Tensor, 形状为 (N, K)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    y_true: torch.Tensor, 形状为 (N,)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    返回:</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    torch.Tensor, 形状为 (N,), 去掉y_true对应元素后每行的最大值</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 将y_true转换为适当的索引格式</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> y_true.unsqueeze(<span class="dv">1</span>).expand_as(y_pred_logits)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 创建一个与y_pred_logits形状相同的掩码，真实标签位置为False，其余为True</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> torch.ones_like(y_pred_logits, dtype<span class="op">=</span>torch.<span class="bu">bool</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    mask.scatter_(<span class="dv">1</span>, indices, <span class="va">False</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 使用掩码来排除y_true对应的列，并计算每一行的最大值</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    max_values <span class="op">=</span> y_pred_logits[mask].view(y_pred_logits.size(<span class="dv">0</span>), <span class="op">-</span><span class="dv">1</span>).<span class="bu">max</span>(dim<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> max_values</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>我们调用已经实现的<a href="https://Open-Book-Studio.github.io/THU-Coursework-Machine-Learning-for-Big-Data/coding_projects/P2_SVM/handy_crafted_linear.html#binaryhingeloss"><code>BinaryHingeLoss</code></a>来实现<code>forward_one_vs_all</code>。</p>
<p>为了方便实现 <code>forward_crammer_singer</code> 方法，首先我们实现一个辅助函数，</p>
<p>注意 PyTorch中的索引有广播机制，我们刚才编程的时候遇到这个问题，实现了一阵才正确实现逻辑。</p>
<p>下面的代码是说明这个问题的最小重现单元，它的运行结果可能超出你的预期，所以编程的时候我们刚才特别注意了这一点。</p>
<div id="cell-23" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> torch.ones(<span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> torch.zeros(<span class="dv">2</span>).to(<span class="bu">int</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>y_pred[:, y_true] <span class="co"># 很多人以为会是 [1, 1], 实际输出 [[1., 1.], [1., 1.]]</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>tensor([[1., 1.],
        [1., 1.]])</code></pre>
</div>
</div>
<p>测试一下函数正确性</p>
<div id="cell-25" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>y_pred_logits <span class="op">=</span> torch.tensor([[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>],</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                             [<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>],</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                             [<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">15</span>],</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                             [<span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>, <span class="dv">19</span>, <span class="dv">20</span>]], dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> torch.tensor([<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>])</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 函数调用</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>max_values <span class="op">=</span> get_max_values_without_true(y_pred_logits, y_true)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>max_values</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>tensor([ 4.,  9., 14., 19.])</code></pre>
</div>
</div>
<p>正确。 现在我们继续实现 <a href="https://Open-Book-Studio.github.io/THU-Coursework-Machine-Learning-for-Big-Data/coding_projects/P2_SVM/handy_crafted_linear.html#multiclasshingeloss.forward_crammer_singer"><code>MultiClassHingeLoss.forward_crammer_singer</code></a>, fastcore 提供 <code>patch</code> 扩展了 Python 的能力，可以支持 Mixin 风格的软件编程。</p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L118" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="multiclasshingeloss.forward_crammer_singer" class="level3" data-number="0.5">
<h3 data-number="0.5" class="anchored" data-anchor-id="multiclasshingeloss.forward_crammer_singer"><span class="header-section-number">0.5</span> MultiClassHingeLoss.forward_crammer_singer</h3>
<blockquote class="blockquote">
<pre><code> MultiClassHingeLoss.forward_crammer_singer (y_pred_logits:torch.Tensor,
                                             y_true:torch.Tensor)</code></pre>
</blockquote>
<p>*L_i = _+*</p>
<div id="cell-28" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_crammer_singer(<span class="va">self</span>:MultiClassHingeLoss, y_pred_logits:torch.Tensor, y_true:torch.Tensor)<span class="op">-&gt;</span>torch.Tensor:</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""L_i = \left[ 1 - (\hat{y_i}^{t_i} - \max_{k </span><span class="ch">\n</span><span class="co">eq t_i} \hat{y_i}^k)) </span><span class="ch">\r</span><span class="co">ight]_+"""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    batch_size, num_classes <span class="op">=</span> y_pred_logits.size()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    y_true_one_hot <span class="op">=</span> torch.eye(num_classes).to(y_pred_logits.device)[y_true]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 计算真实类别的预测值</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    y_true_logits <span class="op">=</span> (y_pred_logits <span class="op">*</span> y_true_one_hot).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y_true_logits = y_pred_logits[:, y_true]</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    max_other_logits <span class="op">=</span> get_max_values_without_true(y_pred_logits, y_true)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    functional_margin_differences <span class="op">=</span> (y_true_logits <span class="op">-</span> max_other_logits)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 计算hinge loss</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    xi <span class="op">=</span> torch.clamp(<span class="va">self</span>.margin <span class="op">-</span> functional_margin_differences, <span class="bu">min</span><span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.squared:</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        xi <span class="op">=</span> xi <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.C <span class="op">*</span> xi.<span class="bu">sum</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>现在我们简单测试一下上面实现的两个Loss是否计算正确，与理论公式一样。</p>
<div id="cell-30" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>y_pred_logits <span class="op">=</span> torch.tensor([[<span class="fl">0.5</span>, <span class="op">-</span><span class="fl">0.5</span>], [<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>]])</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> torch.tensor([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>critierion <span class="op">=</span> MultiClassHingeLoss(strategy<span class="op">=</span><span class="st">"crammer_singer"</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> critierion(y_pred_logits, y_true)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>tensor(0.)</code></pre>
</div>
</div>
<p>上面的结果是正确的，因为 自己这个类别的 预测值 是 0.5, 其他类别的最大预测值是 -0.5, 比它大1, 正好是margin，所以loss为0</p>
<div id="cell-32" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>critierion <span class="op">=</span> MultiClassHingeLoss(strategy<span class="op">=</span><span class="st">"one_vs_all"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> critierion(y_pred_logits, y_true)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>loss</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>tensor(2.)</code></pre>
</div>
</div>
<p>上面的结果也是正确的，这两个数据都是 正确的那个类 自己只有0.5的值，不到1， 而错误的类不到-1，所以有正负类两个样本各有0.5的loss，一共为2。</p>
<p>以上我们实现的Loss在真实情况中会使用哪个组合呢？这也是个值得探讨的问题。</p>
<p>对于多类别的情况，<a href="https://www.csie.ntu.edu.tw/~cjlin/papers/l2mcsvm/l2mcsvm.pdf">论文</a> 详细研究了 crammer_singer 方法 + squared hinge loss 的有效性，所以这两者是可以结合的。</p>
<section id="svm-模型与优化算法实现" class="level4" data-number="0.5.1">
<h4 data-number="0.5.1" class="anchored" data-anchor-id="svm-模型与优化算法实现"><span class="header-section-number">0.5.1</span> SVM 模型与优化算法实现</h4>
<p>在 crammer_singer 方法 和 one vs all 的情况下，SVM的参数<span class="math inline">\(w, b\)</span>的大小是 <code>(n_features, n_classes), (n_classes,)</code>，这与多分类的感知机、Linear+Softmax是一样的。</p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L146" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="hingesupportvectorclassifier" class="level3" data-number="0.6">
<h3 data-number="0.6" class="anchored" data-anchor-id="hingesupportvectorclassifier"><span class="header-section-number">0.6</span> HingeSupportVectorClassifier</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier (input_dim, num_classes, learning_rate=0.01,
                               weight_decay=0.5, optimizer_type=&lt;class
                               'torch.optim.sgd.SGD'&gt;, C:float=1,
                               squared:bool=False, margin:float=1, strateg
                               y:Literal['crammer_singer','one_vs_all']='c
                               rammer_singer', experiment_index=0)</code></pre>
</blockquote>
<p><em>Hooks to be used in LightningModule.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>input_dim</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>num_classes</td>
<td></td>
<td></td>
<td>model related</td>
</tr>
<tr class="odd">
<td>learning_rate</td>
<td>float</td>
<td>0.01</td>
<td></td>
</tr>
<tr class="even">
<td>weight_decay</td>
<td>float</td>
<td>0.5</td>
<td>optimization related</td>
</tr>
<tr class="odd">
<td>optimizer_type</td>
<td>type</td>
<td>SGD</td>
<td></td>
</tr>
<tr class="even">
<td>C</td>
<td>float</td>
<td>1</td>
<td>loss related</td>
</tr>
<tr class="odd">
<td>squared</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr class="even">
<td>margin</td>
<td>float</td>
<td>1</td>
<td></td>
</tr>
<tr class="odd">
<td>strategy</td>
<td>Literal</td>
<td>crammer_singer</td>
<td></td>
</tr>
<tr class="even">
<td>experiment_index</td>
<td>int</td>
<td>0</td>
<td>experiment related</td>
</tr>
</tbody>
</table>
<div id="cell-37" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> overrides <span class="im">import</span> override</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.utilities.types <span class="im">import</span> EVAL_DATALOADERS, TRAIN_DATALOADERS, STEP_OUTPUT, OptimizerLRScheduler</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># lightning imports</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightning <span class="im">as</span> L</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-38" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HingeSupportVectorClassifier(L.LightningModule):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                <span class="co">#  model related</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                 input_dim, num_classes,  </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                <span class="co">#  optimization related</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                 learning_rate<span class="op">=</span><span class="fl">0.01</span>, weight_decay<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                 optimizer_type <span class="op">=</span> optim.SGD, </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                <span class="co">#  loss related</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>                 C: <span class="bu">float</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>                    squared: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                    margin: <span class="bu">float</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>                    strategy: Strategy <span class="op">=</span> <span class="st">'crammer_singer'</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>                <span class="co">#  experiment related</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>                 experiment_index<span class="op">=</span><span class="dv">0</span>,  </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.save_hyperparameters()</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        L.seed_everything(experiment_index)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> nn.Linear(input_dim, num_classes)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loss_fn <span class="op">=</span> MultiClassHingeLoss()</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.example_input_array <span class="op">=</span> torch.randn(<span class="dv">1</span>, input_dim)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dummy_inputs <span class="op">=</span> <span class="bu">dict</span>(input_ids<span class="op">=</span><span class="va">self</span>.example_input_array) <span class="co"># for opendelta and huggingface</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.automatic_optimization <span class="op">=</span> <span class="va">True</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 评价策略</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.evaluation_steps_outputs <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@override</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, image_tensor:torch.Tensor, <span class="op">*</span>args, <span class="op">**</span>kwargs)<span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="co">            torch.Tensor: the predicted functional margin to each class's decision hyperplane   </span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.model(image_tensor)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_geometric_margin(<span class="va">self</span>, image_tensor:torch.Tensor)<span class="op">-&gt;</span>torch.Tensor:</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>        w_norm_each_line <span class="op">=</span> torch.norm(<span class="va">self</span>.model.weight, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.clamp(<span class="va">self</span>(image_tensor) <span class="op">/</span> w_norm_each_line, <span class="bu">min</span><span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_class(<span class="va">self</span>, image_tensor:torch.Tensor)<span class="op">-&gt;</span>torch.Tensor:</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.argmax(<span class="va">self</span>(image_tensor), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward_loss(<span class="va">self</span>, image_tensor: torch.Tensor, label_tensor:torch.Tensor)<span class="op">-&gt;</span>torch.Tensor:</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> <span class="va">self</span>(image_tensor)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.loss_fn(logits, label_tensor)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@override</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> training_step(<span class="va">self</span>, batch, batch_idx<span class="op">=</span><span class="va">None</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs)<span class="op">-&gt;</span> STEP_OUTPUT:</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="va">self</span>.forward_loss(<span class="op">*</span>batch)</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">"train_loss"</span>, loss, prog_bar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> namable_classify.infra <span class="im">import</span> print_model_pretty</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="op">=</span> HingeSupportVectorClassifier(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">10</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>test_model.print_model_pretty()</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>y_pred_logits <span class="op">=</span>test_model(test_model.example_input_array)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>test_model.predict_class(test_model.example_input_array)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>test_model.predict_geometric_margin(test_model.example_input_array)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># y_pred_logits</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># test_model.loss_fn(y_pred_logits, torch.tensor([0]))</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>test_model.forward_loss(test_model.example_input_array, torch.tensor([<span class="dv">0</span>]))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Seed set to 0</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Mon 2024-11-18 20:38:01.629617</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> ╭─────────────────────── Model Tree for HingeSupportVectorClassifier ────────────────────────╮ <a href="file:///home/ye_canming/repos/novelties/cv/ScholarlyInfrastructure/scholarly_infrastructure/logging/torch.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">torch.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/repos/novelties/cv/ScholarlyInfrastructure/scholarly_infrastructure/logging/torch.py#72" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">72</span></a>
         │ <span style="color: #c0c0c0; text-decoration-color: #c0c0c0">root</span>                                                                                       │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">           </span>
         │ └── <span style="color: #c0c0c0; text-decoration-color: #c0c0c0">model </span><span style="color: #008000; text-decoration-color: #008000">(Linear) </span><span style="color: #008080; text-decoration-color: #008080">weight:[10, 784] bias:[10]</span>                                              │ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">           </span>
         ╰────────────────────────────────────────────────────────────────────────────────────────────╯ <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">           </span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div class="ansi-escaped-output">
<pre><span class="ansi-magenta-fg ansi-bold">tensor</span><span class="ansi-bold">(</span><span class="ansi-cyan-fg ansi-bold">1.4472</span>, <span class="ansi-yellow-fg">grad_fn</span>=<span class="ansi-bold">&lt;</span><span class="ansi-bright-magenta-fg ansi-bold">MulBackward0</span><span class="ansi-bold">&gt;</span><span class="ansi-bold">)</span></pre>
</div>
</div>
</div>
<p>我们定义好了 loss 和 model（w与b的参数，以及决策超平面如何用于决策）。 现在我们要定义训练算法。</p>
<p>首先我们来首先一下 上文我们提到的sklearn使用的 Leon Bottou optimal learning rate。从现代深度学习的角度来看，Leon Bottou 本质上是提出了一个 learning rate scheduler。</p>
<p>参照 <a href="https://leon.bottou.org/projects/sgd">Leon Bottou 的SVM网站</a>, 他对学习率的规划如下</p>
<p>SGD</p>
<p><span class="math display">\[
\eta_t = \frac{\eta_0}{(1 + \lambda \eta_0 t)}
\]</span></p>
<p>ASGD</p>
<p><span class="math display">\[
\eta_t = \frac{\eta_0}{(1 + \lambda \eta_0 t)^{0.75}}
\]</span></p>
<p>其中对于第一个形式，是否是一个特殊的[指数/gamma 衰减的学习率]？(https://pytorch.org/docs/stable/generated/torch.optim.lr_scheduler.ExponentialLR.html)。 <span class="math display">\[
{\eta}_{t+1} = \frac{\eta_0}{(1 + \lambda \eta_0 (t+1) )}
\]</span></p>
<p><span class="math display">\[
\gamma = \frac{{\eta}_{t+1}}{\eta_t} = \frac{1}{1+\frac{1}{t + \frac{1}{\lambda \eta_0}}}
\]</span> 答案是否定的，因为 <span class="math inline">\(\gamma\)</span> 推导出来不是和t无关的常数。 所以Leon Bottou不是 gamma衰减的特殊情况。</p>
<div id="cell-43" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>scheduler_lmd_leon_bottou_sgd <span class="op">=</span> <span class="kw">lambda</span> epoch, init_lr<span class="op">=</span><span class="fl">0.1</span>, lmd<span class="op">=</span><span class="fl">0.001</span>: init_lr <span class="op">/</span> (<span class="dv">1</span><span class="op">+</span> lmd<span class="op">*</span>init_lr<span class="op">*</span>epoch)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>scheduler_lmd_leon_bottou_asgd <span class="op">=</span> <span class="kw">lambda</span> epoch, init_lr<span class="op">=</span><span class="fl">0.1</span>, lmd<span class="op">=</span><span class="fl">0.001</span>: init_lr <span class="op">/</span> (<span class="dv">1</span><span class="op">+</span> lmd<span class="op">*</span>init_lr<span class="op">*</span>epoch)<span class="op">**</span><span class="fl">0.75</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>不要忘了刚才还有 <span class="math inline">\(\frac{1}{2} ||w||^2\)</span> 项， 需要特别注意 bias <span class="math inline">\(b\)</span> 没有被decay。<a href="https://discuss.pytorch.org/t/weight-decay-only-for-weights-of-nn-linear-and-nn-conv/114348">博客</a>提到，尽管很多论文都指出了分开这两者的weight decay的重要性，但是在torch中实现这一点还是有一定的难度的。</p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L204" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="separate_weight_decay" class="level3" data-number="0.7">
<h3 data-number="0.7" class="anchored" data-anchor-id="separate_weight_decay"><span class="header-section-number">0.7</span> separate_weight_decay</h3>
<blockquote class="blockquote">
<pre><code> separate_weight_decay (model:torch.nn.modules.module.Module,
                        weight_decay:float, otherwise_set_to:float=0.0,
                        verbose:bool=False)</code></pre>
</blockquote>
<div id="cell-46" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> separate_weight_decay(model:nn.Module, weight_decay: <span class="bu">float</span>, otherwise_set_to:<span class="bu">float</span><span class="op">=</span><span class="fl">0.0</span>, verbose:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    decay <span class="op">=</span> <span class="bu">list</span>() <span class="co"># 不能使用 set，由于Pytorch优化器需要顺序</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    no_decay <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, param <span class="kw">in</span> model.named_parameters():</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        do_weight_decay <span class="op">=</span> <span class="st">'weight'</span> <span class="kw">in</span> name</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> should do weight decay? </span><span class="sc">{</span>do_weight_decay<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> do_weight_decay:</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>            decay.append(param)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>            no_decay.append(param)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return decay, no_decay</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>                <span class="bu">dict</span>(params<span class="op">=</span>decay, weight_decay<span class="op">=</span>weight_decay), </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>                <span class="bu">dict</span>(params<span class="op">=</span>no_decay, weight_decay<span class="op">=</span>otherwise_set_to)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            ]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-47" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>test_model <span class="op">=</span> HingeSupportVectorClassifier(<span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>weight_decay <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>separate_weight_decay(test_model, weight_decay)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="cf">pass</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Seed set to 0</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L224" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.configure_optimizers" class="level3" data-number="0.8">
<h3 data-number="0.8" class="anchored" data-anchor-id="hingesupportvectorclassifier.configure_optimizers"><span class="header-section-number">0.8</span> HingeSupportVectorClassifier.configure_optimizers</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.configure_optimizers ()</code></pre>
</blockquote>
<p>*Choose what optimizers and learning-rate schedulers to use in your optimization. Normally you’d need one. But in the case of GANs or similar you might have multiple. Optimization with multiple optimizers only works in the manual optimization mode.</p>
<p>Return: Any of these 6 options.</p>
<pre><code>- **Single optimizer**.
- **List or Tuple** of optimizers.
- **Two lists** - The first list has multiple optimizers, and the second has multiple LR schedulers
  (or multiple ``lr_scheduler_config``).
- **Dictionary**, with an ``"optimizer"`` key, and (optionally) a ``"lr_scheduler"``
  key whose value is a single LR scheduler or ``lr_scheduler_config``.
- **None** - Fit will run without any optimizer.</code></pre>
<p>The <code>lr_scheduler_config</code> is a dictionary which contains the scheduler and its associated configuration. The default configuration is shown below.</p>
<p>.. code-block:: python</p>
<pre><code>lr_scheduler_config = {
    # REQUIRED: The scheduler instance
    "scheduler": lr_scheduler,
    # The unit of the scheduler's step size, could also be 'step'.
    # 'epoch' updates the scheduler on epoch end whereas 'step'
    # updates it after a optimizer update.
    "interval": "epoch",
    # How many epochs/steps should pass between calls to
    # `scheduler.step()`. 1 corresponds to updating the learning
    # rate after every epoch/step.
    "frequency": 1,
    # Metric to to monitor for schedulers like `ReduceLROnPlateau`
    "monitor": "val_loss",
    # If set to `True`, will enforce that the value specified 'monitor'
    # is available when the scheduler is updated, thus stopping
    # training if not found. If set to `False`, it will only produce a warning
    "strict": True,
    # If using the `LearningRateMonitor` callback to monitor the
    # learning rate progress, this keyword can be used to specify
    # a custom logged name
    "name": None,
}</code></pre>
<p>When there are schedulers in which the <code>.step()</code> method is conditioned on a value, such as the :class:<code>torch.optim.lr_scheduler.ReduceLROnPlateau</code> scheduler, Lightning requires that the <code>lr_scheduler_config</code> contains the keyword <code>"monitor"</code> set to the metric name that the scheduler should be conditioned on.</p>
<p>.. testcode::</p>
<pre><code># The ReduceLROnPlateau scheduler requires a monitor
def configure_optimizers(self):
    optimizer = Adam(...)
    return {
        "optimizer": optimizer,
        "lr_scheduler": {
            "scheduler": ReduceLROnPlateau(optimizer, ...),
            "monitor": "metric_to_track",
            "frequency": "indicates how often the metric is updated",
            # If "monitor" references validation metrics, then "frequency" should be set to a
            # multiple of "trainer.check_val_every_n_epoch".
        },
    }

# In the case of two optimizers, only one using the ReduceLROnPlateau scheduler
def configure_optimizers(self):
    optimizer1 = Adam(...)
    optimizer2 = SGD(...)
    scheduler1 = ReduceLROnPlateau(optimizer1, ...)
    scheduler2 = LambdaLR(optimizer2, ...)
    return (
        {
            "optimizer": optimizer1,
            "lr_scheduler": {
                "scheduler": scheduler1,
                "monitor": "metric_to_track",
            },
        },
        {"optimizer": optimizer2, "lr_scheduler": scheduler2},
    )</code></pre>
<p>Metrics can be made available to monitor by simply logging it using <code>self.log('metric_to_track', metric_val)</code> in your :class:<code>~lightning.pytorch.core.LightningModule</code>.</p>
<p>Note: Some things to know:</p>
<pre><code>- Lightning calls ``.backward()`` and ``.step()`` automatically in case of automatic optimization.
- If a learning rate scheduler is specified in ``configure_optimizers()`` with key
  ``"interval"`` (default "epoch") in the scheduler configuration, Lightning will call
  the scheduler's ``.step()`` method automatically in case of automatic optimization.
- If you use 16-bit precision (``precision=16``), Lightning will automatically handle the optimizer.
- If you use :class:`torch.optim.LBFGS`, Lightning handles the closure function automatically for you.
- If you use multiple optimizers, you will have to switch to 'manual optimization' mode and step them
  yourself.
- If you need to control how often the optimizer steps, override the :meth:`optimizer_step` hook.*</code></pre>
<div id="cell-49" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="at">@override</span>    </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> configure_optimizers(<span class="va">self</span>:HingeSupportVectorClassifier) <span class="op">-&gt;</span> OptimizerLRScheduler:</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    init_lr <span class="op">=</span> <span class="va">self</span>.hparams.learning_rate</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lmd = self.hparams.weight_decay / self.hparams.C </span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    lmd <span class="op">=</span> <span class="va">self</span>.hparams.weight_decay <span class="co"># 需要考证，Leon Bottou的lamda 是什么情况下推导的。</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    weight_decay <span class="op">=</span> <span class="va">self</span>.hparams.weight_decay</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.hparams.optimizer_type <span class="op">==</span> torch.optim.ASGD:</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> torch.optim.ASGD(</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self.parameters(), </span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>            separate_weight_decay(<span class="va">self</span>, weight_decay), </span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                                    lr<span class="op">=</span>init_lr,  <span class="co"># 刚才 save_hyperparameters() 保存了，这是为了方便是使用 Lightning 调学习率</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># weight_decay = self.hparams.weight_decay, # 李航书上的 hinge loss的第一项</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>                                    ) </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        scheduler <span class="op">=</span> torch.optim.lr_scheduler.LambdaLR(optimizer,</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>                lr_lambda<span class="op">=</span><span class="kw">lambda</span> epoch: scheduler_lmd_leon_bottou_asgd(epoch, init_lr, lmd))</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="va">self</span>.hparams.optimizer_type <span class="op">==</span> torch.optim.SGD:</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> torch.optim.SGD(</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self.parameters(), </span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>            separate_weight_decay(<span class="va">self</span>, weight_decay), </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>                                    lr<span class="op">=</span>init_lr,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># weight_decay=self.hparams.weight_decay</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        scheduler <span class="op">=</span> torch.optim.lr_scheduler.LambdaLR(optimizer,</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>                lr_lambda<span class="op">=</span><span class="kw">lambda</span> epoch: scheduler_lmd_leon_bottou_sgd(epoch, init_lr, lmd))</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.hparams.optimizer_type(<span class="va">self</span>.parameters(), lr<span class="op">=</span>init_lr, weight_decay<span class="op">=</span><span class="va">self</span>.hparams.weight_decay) <span class="co"># 只 return optimizer</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ([optimizer], [scheduler])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>最后我们补上评价指标</p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L329" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.test_step" class="level3" data-number="0.9">
<h3 data-number="0.9" class="anchored" data-anchor-id="hingesupportvectorclassifier.test_step"><span class="header-section-number">0.9</span> HingeSupportVectorClassifier.test_step</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.test_step (batch, batch_idx=None, *args,
                                         **kwargs)</code></pre>
</blockquote>
<p>*Operates on a single batch of data from the test set. In this step you’d normally generate examples or calculate anything of interest such as accuracy.</p>
<p>Args: batch: The output of your data iterable, normally a :class:<code>~torch.utils.data.DataLoader</code>. batch_idx: The index of this batch. dataloader_idx: The index of the dataloader that produced this batch. (only if multiple dataloaders used)</p>
<p>Return: - :class:<code>~torch.Tensor</code> - The loss tensor - <code>dict</code> - A dictionary. Can include any keys, but must include the key <code>'loss'</code>. - <code>None</code> - Skip to the next batch.</p>
<p>.. code-block:: python</p>
<pre><code># if you have one test dataloader:
def test_step(self, batch, batch_idx): ...

# if you have multiple test dataloaders:
def test_step(self, batch, batch_idx, dataloader_idx=0): ...</code></pre>
<p>Examples::</p>
<pre><code># CASE 1: A single test dataset
def test_step(self, batch, batch_idx):
    x, y = batch

    # implement your own
    out = self(x)
    loss = self.loss(out, y)

    # log 6 example images
    # or generated text... or whatever
    sample_imgs = x[:6]
    grid = torchvision.utils.make_grid(sample_imgs)
    self.logger.experiment.add_image('example_images', grid, 0)

    # calculate acc
    labels_hat = torch.argmax(out, dim=1)
    test_acc = torch.sum(y == labels_hat).item() / (len(y) * 1.0)

    # log the outputs!
    self.log_dict({'test_loss': loss, 'test_acc': test_acc})</code></pre>
<p>If you pass in multiple test dataloaders, :meth:<code>test_step</code> will have an additional argument. We recommend setting the default value of 0 so that you can quickly switch between single and multiple dataloaders.</p>
<p>.. code-block:: python</p>
<pre><code># CASE 2: multiple test dataloaders
def test_step(self, batch, batch_idx, dataloader_idx=0):
    # dataloader_idx tells you which dataset this is.
    ...</code></pre>
<p>Note: If you don’t need to test you don’t need to implement this method.</p>
<p>Note: When the :meth:<code>test_step</code> is called, the model has been put in eval mode and PyTorch gradients have been disabled. At the end of the test epoch, the model goes back to training mode and gradients are enabled.*</p>
<div id="cell-52" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> namable_classify.infra <span class="im">import</span> append_dict_list, ensure_array</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-53" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_evaluation_epoch_start(<span class="va">self</span>:HingeSupportVectorClassifier, stage:<span class="bu">str</span><span class="op">=</span><span class="st">""</span>):</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.evaluation_steps_outputs <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.evaluation_steps_outputs[<span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_batch_probs'</span>] <span class="op">=</span> []</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.evaluation_steps_outputs[<span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_label_tensor'</span>] <span class="op">=</span> []</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.evaluation_steps_outputs[f'{stage}_batch_preds'] = []</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluation_step(<span class="va">self</span>:HingeSupportVectorClassifier, batch, batch_idx<span class="op">=</span><span class="va">None</span>, stage:<span class="bu">str</span><span class="op">=</span><span class="st">""</span>, <span class="op">*</span>args: Any, <span class="op">**</span>kwargs: Any) <span class="op">-&gt;</span> STEP_OUTPUT:</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    image_tensor, label_tensor <span class="op">=</span> batch</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    batch_probs <span class="op">=</span> <span class="va">self</span>(image_tensor)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># batch_preds = self.predict_class(image_tensor)</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    append_dict_list(<span class="va">self</span>.evaluation_steps_outputs, <span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_batch_probs'</span>, ensure_array(batch_probs))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    append_dict_list(<span class="va">self</span>.evaluation_steps_outputs, <span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_label_tensor'</span>, ensure_array(label_tensor))</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># append_dict_list(self.evaluation_steps_outputs, f'{stage}_batch_preds', ensure_array(batch_preds))</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    batch_loss <span class="op">=</span> <span class="va">self</span>.loss_fn(batch_probs, label_tensor)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.log(<span class="ss">f"</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_loss"</span>, batch_loss, prog_bar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> batch_loss</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_evaluation_epoch_end(<span class="va">self</span>:HingeSupportVectorClassifier, stage:<span class="bu">str</span><span class="op">=</span><span class="st">""</span>):</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># https://github.com/Lightning-AI/pytorch-lightning/discussions/9845</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># labels = self.lit_data.classes</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># labels = list(range(self.lit_data.num_of_classes))</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="va">self</span>.hparams.num_classes))</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># labels = None</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(labels)</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># stack 是 new axis， concat是existing axis</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    all_pred_probs <span class="op">=</span> np.concatenate(<span class="va">self</span>.evaluation_steps_outputs[<span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_batch_probs'</span>])</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    all_label_tensor <span class="op">=</span> np.concatenate(<span class="va">self</span>.evaluation_steps_outputs[<span class="ss">f'</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_label_tensor'</span>])</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># all_preds = np.concatenate(self.evaluation_steps_outputs[f'{stage}_batch_preds'])</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># logger.debug(self.evaluation_steps_outputs[f'{stage}_label_tensor'])</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># logger.debug(all_label_tensor)</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    eval_dict <span class="op">=</span> compute_classification_metrics(all_label_tensor, all_pred_probs, </span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>                                            <span class="co">#    logits_to_prob=False, </span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>                                                logits_to_prob<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>                                            labels<span class="op">=</span>labels)</span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>    eval_dict <span class="op">=</span> {<span class="ss">f"</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>: v <span class="cf">for</span> k,v <span class="kw">in</span> eval_dict.items()}</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.log_dict(eval_dict)</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.evaluation_steps_outputs.clear()</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="at">@override</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_validation_epoch_start(<span class="va">self</span>:HingeSupportVectorClassifier):</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.on_evaluation_epoch_start(stage<span class="op">=</span><span class="st">"val"</span>)</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="at">@override</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_test_epoch_start(<span class="va">self</span>:HingeSupportVectorClassifier):</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.on_evaluation_epoch_start(stage<span class="op">=</span><span class="st">"test"</span>)</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a><span class="at">@override</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_validation_epoch_end(<span class="va">self</span>:HingeSupportVectorClassifier):</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.on_evaluation_epoch_end(stage<span class="op">=</span><span class="st">"val"</span>)</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a><span class="at">@override</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_test_epoch_end(<span class="va">self</span>:HingeSupportVectorClassifier):</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.on_evaluation_epoch_end(stage<span class="op">=</span><span class="st">"test"</span>)</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="at">@override</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validation_step(<span class="va">self</span>:HingeSupportVectorClassifier, batch, batch_idx<span class="op">=</span><span class="va">None</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.evaluation_step(batch, batch_idx, stage<span class="op">=</span><span class="st">"val"</span>)</span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a><span class="at">@override</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_step(<span class="va">self</span>:HingeSupportVectorClassifier, batch, batch_idx<span class="op">=</span><span class="va">None</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.evaluation_step(batch, batch_idx, stage<span class="op">=</span><span class="st">"test"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L324" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.validation_step" class="level3" data-number="0.10">
<h3 data-number="0.10" class="anchored" data-anchor-id="hingesupportvectorclassifier.validation_step"><span class="header-section-number">0.10</span> HingeSupportVectorClassifier.validation_step</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.validation_step (batch, batch_idx=None,
                                               *args, **kwargs)</code></pre>
</blockquote>
<p>*Operates on a single batch of data from the validation set. In this step you’d might generate examples or calculate anything of interest like accuracy.</p>
<p>Args: batch: The output of your data iterable, normally a :class:<code>~torch.utils.data.DataLoader</code>. batch_idx: The index of this batch. dataloader_idx: The index of the dataloader that produced this batch. (only if multiple dataloaders used)</p>
<p>Return: - :class:<code>~torch.Tensor</code> - The loss tensor - <code>dict</code> - A dictionary. Can include any keys, but must include the key <code>'loss'</code>. - <code>None</code> - Skip to the next batch.</p>
<p>.. code-block:: python</p>
<pre><code># if you have one val dataloader:
def validation_step(self, batch, batch_idx): ...

# if you have multiple val dataloaders:
def validation_step(self, batch, batch_idx, dataloader_idx=0): ...</code></pre>
<p>Examples::</p>
<pre><code># CASE 1: A single validation dataset
def validation_step(self, batch, batch_idx):
    x, y = batch

    # implement your own
    out = self(x)
    loss = self.loss(out, y)

    # log 6 example images
    # or generated text... or whatever
    sample_imgs = x[:6]
    grid = torchvision.utils.make_grid(sample_imgs)
    self.logger.experiment.add_image('example_images', grid, 0)

    # calculate acc
    labels_hat = torch.argmax(out, dim=1)
    val_acc = torch.sum(y == labels_hat).item() / (len(y) * 1.0)

    # log the outputs!
    self.log_dict({'val_loss': loss, 'val_acc': val_acc})</code></pre>
<p>If you pass in multiple val dataloaders, :meth:<code>validation_step</code> will have an additional argument. We recommend setting the default value of 0 so that you can quickly switch between single and multiple dataloaders.</p>
<p>.. code-block:: python</p>
<pre><code># CASE 2: multiple validation dataloaders
def validation_step(self, batch, batch_idx, dataloader_idx=0):
    # dataloader_idx tells you which dataset this is.
    ...</code></pre>
<p>Note: If you don’t need to validate you don’t need to implement this method.</p>
<p>Note: When the :meth:<code>validation_step</code> is called, the model has been put in eval mode and PyTorch gradients have been disabled. At the end of validation, the model goes back to training mode and gradients are enabled.*</p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L319" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.on_test_epoch_end" class="level3" data-number="0.11">
<h3 data-number="0.11" class="anchored" data-anchor-id="hingesupportvectorclassifier.on_test_epoch_end"><span class="header-section-number">0.11</span> HingeSupportVectorClassifier.on_test_epoch_end</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.on_test_epoch_end ()</code></pre>
</blockquote>
<p><em>Called in the test loop at the very end of the epoch.</em></p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L314" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.on_validation_epoch_end" class="level3" data-number="0.12">
<h3 data-number="0.12" class="anchored" data-anchor-id="hingesupportvectorclassifier.on_validation_epoch_end"><span class="header-section-number">0.12</span> HingeSupportVectorClassifier.on_validation_epoch_end</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.on_validation_epoch_end ()</code></pre>
</blockquote>
<p><em>Called in the validation loop at the very end of the epoch.</em></p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L309" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.on_test_epoch_start" class="level3" data-number="0.13">
<h3 data-number="0.13" class="anchored" data-anchor-id="hingesupportvectorclassifier.on_test_epoch_start"><span class="header-section-number">0.13</span> HingeSupportVectorClassifier.on_test_epoch_start</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.on_test_epoch_start ()</code></pre>
</blockquote>
<p><em>Called in the test loop at the very beginning of the epoch.</em></p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L304" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.on_validation_epoch_start" class="level3" data-number="0.14">
<h3 data-number="0.14" class="anchored" data-anchor-id="hingesupportvectorclassifier.on_validation_epoch_start"><span class="header-section-number">0.14</span> HingeSupportVectorClassifier.on_validation_epoch_start</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.on_validation_epoch_start ()</code></pre>
</blockquote>
<p><em>Called in the validation loop at the very beginning of the epoch.</em></p>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L281" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.on_evaluation_epoch_end" class="level3" data-number="0.15">
<h3 data-number="0.15" class="anchored" data-anchor-id="hingesupportvectorclassifier.on_evaluation_epoch_end"><span class="header-section-number">0.15</span> HingeSupportVectorClassifier.on_evaluation_epoch_end</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.on_evaluation_epoch_end (stage:str='')</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L269" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.evaluation_step" class="level3" data-number="0.16">
<h3 data-number="0.16" class="anchored" data-anchor-id="hingesupportvectorclassifier.evaluation_step"><span class="header-section-number">0.16</span> HingeSupportVectorClassifier.evaluation_step</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.evaluation_step (batch, batch_idx=None,
                                               stage:str='', *args:Any,
                                               **kwargs:Any)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/thu_big_data_ml/svm/handy_crafted/linear.py#L262" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="hingesupportvectorclassifier.on_evaluation_epoch_start" class="level3" data-number="0.17">
<h3 data-number="0.17" class="anchored" data-anchor-id="hingesupportvectorclassifier.on_evaluation_epoch_start"><span class="header-section-number">0.17</span> HingeSupportVectorClassifier.on_evaluation_epoch_start</h3>
<blockquote class="blockquote">
<pre><code> HingeSupportVectorClassifier.on_evaluation_epoch_start (stage:str='')</code></pre>
</blockquote>
<div id="cell-62" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>input_dim <span class="op">=</span> X_val.shape[<span class="dv">1</span>]</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>num_of_classes <span class="op">=</span> <span class="bu">len</span>(categories)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>input_dim, num_of_classes</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold">(</span><span class="ansi-cyan-fg ansi-bold">64</span>, <span class="ansi-cyan-fg ansi-bold">10</span><span class="ansi-bold">)</span></pre>
</div>
</div>
</div>
<div id="cell-63" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>get_cls_task <span class="op">=</span> <span class="kw">lambda</span>: HingeSupportVectorClassifier(input_dim, num_of_classes, </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>                                        learning_rate<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                                        weight_decay<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                        optimizer_type<span class="op">=</span>torch.optim.ASGD, C<span class="op">=</span><span class="dv">1</span>, squared<span class="op">=</span><span class="va">True</span>, margin<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                        strategy<span class="op">=</span><span class="st">"crammer_singer"</span>, experiment_index<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>cls_task <span class="op">=</span> get_cls_task()</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>cls_data <span class="op">=</span> data_module</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># cls_data = data_module_full</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Seed set to 0</code></pre>
</div>
</div>
<section id="svm-训练与评价" class="level4" data-number="0.17.1">
<h4 data-number="0.17.1" class="anchored" data-anchor-id="svm-训练与评价"><span class="header-section-number">0.17.1</span> SVM 训练与评价</h4>
<div id="cell-65" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> thu_big_data_ml.<span class="bu">help</span> <span class="im">import</span> runs_path</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.callbacks.early_stopping <span class="im">import</span> EarlyStopping</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.callbacks <span class="im">import</span> ModelSummary, LearningRateMonitor, LearningRateFinder, BatchSizeFinder</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-66" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> L.Trainer(default_root_dir<span class="op">=</span>runs_path, </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                    enable_checkpointing<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                    enable_model_summary<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># num_sanity_val_steps=2, # 防止 val 在训了好久train才发现崩溃</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                    callbacks<span class="op">=</span>[</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>                        EarlyStopping(monitor<span class="op">=</span><span class="st">"val_acc1"</span>, mode<span class="op">=</span><span class="st">"max"</span>, check_finite<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                                      patience<span class="op">=</span><span class="dv">5</span>, </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>                                      check_on_train_epoch_end<span class="op">=</span><span class="va">False</span>,  <span class="co"># check on validation end</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>                                      verbose<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>                        ModelSummary(max_depth<span class="op">=</span><span class="dv">3</span>),</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># LearningRateFinder(), </span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># BatchSizeFinder(), </span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>                        LearningRateMonitor(logging_interval<span class="op">=</span><span class="st">"epoch"</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>                               ]</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># , fast_dev_run=True</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># , limit_train_batches=10, </span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># limit_val_batches=5</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>                    , accelerator<span class="op">=</span><span class="st">"gpu"</span>, devices<span class="op">=</span><span class="dv">1</span>, strategy<span class="op">=</span><span class="st">"auto"</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>                    )</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/plugins/environments/slurm.py:204: The `srun` command is available on your system but is not used. HINT: If your intention is to run Lightning on SLURM, prepend your python command with `srun` like so: srun python /home/ye_canming/program_files/managers/conda/envs/y ...
Trainer already configured with model summary callbacks: [&lt;class 'lightning.pytorch.callbacks.model_summary.ModelSummary'&gt;]. Skipping setting a default `ModelSummary` callback.
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs</code></pre>
</div>
</div>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>trainer.fit(cls_task, datamodule<span class="op">=</span>cls_data)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>val_res <span class="op">=</span> trainer.validate(cls_task, datamodule<span class="op">=</span>cls_data)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>test_res <span class="op">=</span> trainer.test(cls_task, datamodule<span class="op">=</span>cls_data)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="cf">pass</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/loops/utilities.py:72: `max_epochs` was not set. Setting it to 1000 epochs. To train without an epoch limit, set `max_epochs=-1`.
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:49.020341</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: 
  | Name    | Type                | Params | Mode  | In sizes | Out sizes
-------------------------------------------------------------------------------
0 | model   | Linear              | 650    | train | [1, 64]  | [1, 10]  
1 | loss_fn | MultiClassHingeLoss | 0      | train | ?        | ?        
-------------------------------------------------------------------------------
650       Trainable params
0         Non-trainable params
650       Total params
0.003     Total estimated model params size (MB)
2         Modules in train mode
0         Modules in eval mode</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:49.057947</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span>                                                                                       <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/model_summary.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">model_summary.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/model_summary.py#104" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">104</span></a>
           | Name    | Type                | Params | Mode  | In sizes | Out sizes             <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         -------------------------------------------------------------------------------       <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> | model   | Linear              | <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">650</span>    | train | <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">64</span><span style="font-weight: bold">]</span>  | <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span><span style="font-weight: bold">]</span>               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> | loss_fn | MultiClassHingeLoss | <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>      | train | ?        | ?                     <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         -------------------------------------------------------------------------------       <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">650</span>       Trainable params                                                            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>         Non-trainable params                                                        <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">650</span>       Total params                                                                <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.003</span>     Total estimated model params size <span style="font-weight: bold">(</span>MB<span style="font-weight: bold">)</span>                                      <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>         Modules in train mode                                                       <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>         Modules in eval mode                                                        <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"669621266186426bbde3e17a74a340ae","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/loops/fit_loop.py:298: The number of training batches (11) is smaller than the logging interval Trainer(log_every_n_steps=50). Set a lower value for log_every_n_steps if you want to see logs for the training epoch.</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"04b061b76bf24bddbcbabc9d11afbc77","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"053fbb3122cf4d35af81629c318604e1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Metric val_acc1 improved. New best score: 0.514</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:52.534348</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Metric val_acc1 improved. New best score: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.514</span>                                      <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">early_stopping.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py#273" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">273</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e4a8c9db40294514bf252c6dc7973e0b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Metric val_acc1 improved by 0.229 &gt;= min_delta = 0.0. New best score: 0.743</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:55.733727</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Metric val_acc1 improved by <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.229</span> &gt;= min_delta = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>. New best score: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.743</span>          <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">early_stopping.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py#273" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">273</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c2c6803ec6aa4995bcdc4cc02f240b32","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b938e03815464616b846d33157e0752c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Metric val_acc1 improved by 0.007 &gt;= min_delta = 0.0. New best score: 0.750</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:59:01.783794</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Metric val_acc1 improved by <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.007</span> &gt;= min_delta = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>. New best score: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.750</span>          <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">early_stopping.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py#273" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">273</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"293324207efa42d191278df8fca246ea","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c020c8b651364b5e9727852978e185eb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"78bb116d540f4e42a280f4964066a52d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Metric val_acc1 improved by 0.111 &gt;= min_delta = 0.0. New best score: 0.861</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:59:09.920693</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Metric val_acc1 improved by <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.111</span> &gt;= min_delta = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>. New best score: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.861</span>          <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">early_stopping.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py#273" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">273</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1fb80056dda34a29a210055fcceb59a5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c553d60d7c364e25a8bdd091ae8324ea","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Metric val_acc1 improved by 0.042 &gt;= min_delta = 0.0. New best score: 0.903</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:59:14.194501</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Metric val_acc1 improved by <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.042</span> &gt;= min_delta = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span>. New best score: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.903</span>          <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">early_stopping.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py#273" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">273</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"364be88c907c4ff9ae8596af8586fdc1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a0b22893e3314129bb6177161fd26d42","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0fbe5961a8cf49edbc4525d9dd1eb639","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6ce922d6a558463a8fab2a4ac3ae63a9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f74184c1eade402097846210a31ca8de","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Monitored metric val_acc1 did not improve in the last 5 records. Best score: 0.903. Signaling Trainer to stop.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:59:26.505406</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Monitored metric val_acc1 did not improve in the last <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> records. Best score: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.903</span>.  <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">early_stopping.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/early_stopping.py#273" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">273</span></a>
         Signaling Trainer to stop.                                                           <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                     </span>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/plugins/environments/slurm.py:204: The `srun` command is available on your system but is not used. HINT: If your intention is to run Lightning on SLURM, prepend your python command with `srun` like so: srun python /home/ye_canming/program_files/managers/conda/envs/y ...
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:59:27.127571</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2013eb5f559b44dc831c0023d53ea153","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">      Validate metric      </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         val_acc1          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8541666865348816     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc10         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc2          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9513888955116272     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc20         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc3          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9652777910232544     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc5          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9791666865348816     </span>│
│<span style="color: #008080; text-decoration-color: #008080">   val_balanced_accuracy   </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8519047498703003     </span>│
│<span style="color: #008080; text-decoration-color: #008080">      val_cohen_kappa      </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8378465175628662     </span>│
│<span style="color: #008080; text-decoration-color: #008080">          val_f1           </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8545861840248108     </span>│
│<span style="color: #008080; text-decoration-color: #008080">      val_hinge_loss       </span>│<span style="color: #800080; text-decoration-color: #800080">    0.29842936992645264    </span>│
│<span style="color: #008080; text-decoration-color: #008080">       val_log_loss        </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9072062373161316     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_loss          </span>│<span style="color: #800080; text-decoration-color: #800080">     263.0315856933594     </span>│
│<span style="color: #008080; text-decoration-color: #008080">   val_matthews_corrcoef   </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8427900671958923     </span>│
│<span style="color: #008080; text-decoration-color: #008080">       val_precision       </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8835164904594421     </span>│
│<span style="color: #008080; text-decoration-color: #008080">        val_recall         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8519047498703003     </span>│
│<span style="color: #008080; text-decoration-color: #008080">        val_roc_auc        </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9750232100486755     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/plugins/environments/slurm.py:204: The `srun` command is available on your system but is not used. HINT: If your intention is to run Lightning on SLURM, prepend your python command with `srun` like so: srun python /home/ye_canming/program_files/managers/conda/envs/y ...
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:59:28.313136</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c71a030be92441db8ea403c5297e5be3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         test_acc1         </span>│<span style="color: #800080; text-decoration-color: #800080">     0.855555534362793     </span>│
│<span style="color: #008080; text-decoration-color: #008080">        test_acc10         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_acc2         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9027777910232544     </span>│
│<span style="color: #008080; text-decoration-color: #008080">        test_acc20         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_acc3         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9444444179534912     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_acc5         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9694444537162781     </span>│
│<span style="color: #008080; text-decoration-color: #008080">  test_balanced_accuracy   </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8538845777511597     </span>│
│<span style="color: #008080; text-decoration-color: #008080">     test_cohen_kappa      </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8394717574119568     </span>│
│<span style="color: #008080; text-decoration-color: #008080">          test_f1          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8514753580093384     </span>│
│<span style="color: #008080; text-decoration-color: #008080">      test_hinge_loss      </span>│<span style="color: #800080; text-decoration-color: #800080">    0.30003729462623596    </span>│
│<span style="color: #008080; text-decoration-color: #008080">       test_log_loss       </span>│<span style="color: #800080; text-decoration-color: #800080">     1.314468264579773     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_loss         </span>│<span style="color: #800080; text-decoration-color: #800080">     328.9302062988281     </span>│
│<span style="color: #008080; text-decoration-color: #008080">  test_matthews_corrcoef   </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8407779932022095     </span>│
│<span style="color: #008080; text-decoration-color: #008080">      test_precision       </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8590342998504639     </span>│
│<span style="color: #008080; text-decoration-color: #008080">        test_recall        </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8538845777511597     </span>│
│<span style="color: #008080; text-decoration-color: #008080">       test_roc_auc        </span>│<span style="color: #800080; text-decoration-color: #800080">    0.9722300171852112     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div>
</div>
</section>
</section>
<section id="对手动实现的svm进行调参" class="level3" data-number="0.18">
<h3 data-number="0.18" class="anchored" data-anchor-id="对手动实现的svm进行调参"><span class="header-section-number">0.18</span> 对手动实现的SVM进行调参</h3>
<p>要想进行调参，我们需要首先思考一下，实际上有哪些元参数是必要的。</p>
<p>首先<code>optimizer_type</code>选择ASGD还是SGD，<code>squared</code>是hinge loss还是squared hinge loss，<code>strategy</code>使用crammer_singer还是one vs all, 这三个参数的选择自然是会影响到最终的结果，是重要的目标元参数或者冗余元参数。然而，剩下的<code>learning_rate</code>,<code>weight_decay</code>和<code>C</code>, <code>margin</code>我们可以发现，本质上只有前两个。C和learning_rate是一样的效果，而margin是一个函数间隔，也是可以任意选取的，不影响优化问题的最优解（当然会一定程度影响landscape）。</p>
<p>因此，对于软间隔的Linear SVM的原始问题，我们只需要在给定优化器、损失函数、多分类策略的情况下，只需要调整现代深度学习中也很重要的<code>learning_rate</code>,<code>weight_decay</code>参数。</p>
<p>我在上次Project作业KD树中详细描述了谷歌AI团队《深度学习调优指南》的思想，涉及到的概念包括目标元参数、冗余元参数和固定元参数，贝叶斯优化、演化计算、近似随机搜索，科学实验的控制变量法与调参实验设计中的探索与利用、调参结果的假设检验分析等。这里我们不再赘述，需要的话可以阅读<a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/blob/main/notebooks/coding_projects/P1_KNN/kd_tree.ipynb">上次作业的文档</a>。</p>
<p>与上次作业不同，今天我们调的参数（学习率）具有一定的特殊性，因为我们今天的模型是个可以SGD优化的模型，所以我们可以用到深度学习论文中提出的一些调参方法来进行调参。具体而言，我们今天学习的是这篇经典论文<a href="https://ieeexplore.ieee.org/abstract/document/7926641">Cyclical Learning Rates for Training Neural Networks</a> 的调参方法，具体的实现已经集成到 lightning 库中，我们可以直接使用。</p>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightning.pytorch.tuner <span class="im">import</span> Tuner</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>cls_task <span class="op">=</span> get_cls_task()</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>tuner_trainer <span class="op">=</span> L.Trainer()</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> Tuner(tuner_trainer)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>lr_finder <span class="op">=</span> tuner.lr_find(cls_task, datamodule<span class="op">=</span>cls_data, max_lr<span class="op">=</span><span class="dv">10</span>, min_lr<span class="op">=</span><span class="fl">1e-6</span>, num_training<span class="op">=</span><span class="dv">100</span>, mode <span class="op">=</span> <span class="st">"exponential"</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print(lr_finder.results)</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> lr_finder.plot(suggest<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>new_lr <span class="op">=</span> lr_finder.suggestion()</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>new_lr, cls_task.hparams.learning_rate</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Seed set to 0</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:52:49.912254</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Seed set to <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                                                   <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/utilities/seed.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">seed.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/utilities/seed.py#57" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">57</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Trainer will use only 1 of 8 GPUs because it is running inside an interactive / notebook environment. You may try to set `Trainer(devices=8)` but please note that multi-GPU inside interactive / notebook environments is considered experimental and unstable. Your mileage may vary.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:52:49.928983</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Trainer will use only <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> of <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span> GPUs because it is running inside an interactive <span style="color: #800080; text-decoration-color: #800080">/</span> notebook   <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
         environment. You may try to set `<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Trainer</span><span style="font-weight: bold">(</span><span style="color: #808000; text-decoration-color: #808000">devices</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span><span style="font-weight: bold">)</span>` but please note that multi-GPU inside <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         interactive <span style="color: #800080; text-decoration-color: #800080">/</span> notebook environments is considered experimental and unstable. Your mileage  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         may vary.                                                                                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: GPU available: True (cuda), used: True</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:52:49.953772</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> GPU available: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span> <span style="font-weight: bold">(</span>cuda<span style="font-weight: bold">)</span>, used: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                     <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: TPU available: False, using: 0 TPU cores</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:52:49.958918</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> TPU available: <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>, using: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> TPU cores                                                   <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: HPU available: False, using: 0 HPUs</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:52:49.962648</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> HPU available: <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>, using: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> HPUs                                                        <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:52:49.972189</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f906209820c3420b95cf8fac9e5425b4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: LR finder stopped early after 85 steps due to diverging loss.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:53:03.916698</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LR finder stopped early after <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">85</span> steps due to diverging loss.                             <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/tuner/lr_finder.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">lr_finder.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/tuner/lr_finder.py#282" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">282</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Learning rate set to 3.467368504525316e-05</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:53:03.941939</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Learning rate set to <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3.467368504525316e-05</span>                                                <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/tuner/lr_finder.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">lr_finder.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/tuner/lr_finder.py#301" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">301</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Restoring states from the checkpoint path at /home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/coding_projects/P2_SVM/.lr_find_eeb25b7b-6568-46de-b7da-ccdf5af0b22b.ckpt</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:53:03.946531</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Restoring states from the checkpoint path at                                               <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
         <span style="color: #800080; text-decoration-color: #800080">/home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/</span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         <span style="color: #800080; text-decoration-color: #800080">coding_projects/P2_SVM/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">.lr_find_eeb25b7b-6568-46de-b7da-ccdf5af0b22b.ckpt</span>                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Restored all states from the checkpoint at /home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/coding_projects/P2_SVM/.lr_find_eeb25b7b-6568-46de-b7da-ccdf5af0b22b.ckpt</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:53:03.962106</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Restored all states from the checkpoint at                                                 <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
         <span style="color: #800080; text-decoration-color: #800080">/home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/</span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         <span style="color: #800080; text-decoration-color: #800080">coding_projects/P2_SVM/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">.lr_find_eeb25b7b-6568-46de-b7da-ccdf5af0b22b.ckpt</span>                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold">(</span><span class="ansi-cyan-fg ansi-bold">3.467368504525316e-05</span>, <span class="ansi-cyan-fg ansi-bold">3.467368504525316e-05</span><span class="ansi-bold">)</span></pre>
</div>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02svm_handy_crafted_linear_files/figure-html/cell-48-output-35.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>这个方法我认为也可以用于调整weight decay。</p>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>cls_task <span class="op">=</span> get_cls_task()</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>cls_task.hparams.learning_rate <span class="op">=</span> new_lr</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>tuner_trainer <span class="op">=</span> L.Trainer()</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> Tuner(tuner_trainer)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>weight_decay_finder <span class="op">=</span> tuner.lr_find(cls_task, datamodule<span class="op">=</span>cls_data, max_lr<span class="op">=</span><span class="fl">1e-3</span>, min_lr<span class="op">=</span><span class="fl">1e-5</span>, num_training<span class="op">=</span><span class="dv">50</span>, attr_name<span class="op">=</span><span class="st">'weight_decay'</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Seed set to 0</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:03.777345</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Seed set to <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                                                   <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/utilities/seed.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">seed.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/utilities/seed.py#57" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">57</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Trainer will use only 1 of 8 GPUs because it is running inside an interactive / notebook environment. You may try to set `Trainer(devices=8)` but please note that multi-GPU inside interactive / notebook environments is considered experimental and unstable. Your mileage may vary.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:03.800328</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Trainer will use only <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> of <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span> GPUs because it is running inside an interactive <span style="color: #800080; text-decoration-color: #800080">/</span> notebook   <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
         environment. You may try to set `<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Trainer</span><span style="font-weight: bold">(</span><span style="color: #808000; text-decoration-color: #808000">devices</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span><span style="font-weight: bold">)</span>` but please note that multi-GPU inside <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         interactive <span style="color: #800080; text-decoration-color: #800080">/</span> notebook environments is considered experimental and unstable. Your mileage  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         may vary.                                                                                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: GPU available: True (cuda), used: True</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:03.836096</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> GPU available: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span> <span style="font-weight: bold">(</span>cuda<span style="font-weight: bold">)</span>, used: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                     <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: TPU available: False, using: 0 TPU cores</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:03.852469</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> TPU available: <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>, using: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> TPU cores                                                   <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: HPU available: False, using: 0 HPUs</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:03.868754</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> HPU available: <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>, using: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> HPUs                                                        <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:03.892937</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"63e79c7df2d94e5e88b7431afe0c2347","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: `Trainer.fit` stopped: `max_steps=50` reached.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:11.843827</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> `Trainer.fit` stopped: `<span style="color: #808000; text-decoration-color: #808000">max_steps</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">50</span>` reached.                                             <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Learning rate set to 7.585775750291839e-05</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:11.865877</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Learning rate set to <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7.585775750291839e-05</span>                                                <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/tuner/lr_finder.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">lr_finder.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/tuner/lr_finder.py#301" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">301</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Restoring states from the checkpoint path at /home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/coding_projects/P2_SVM/.lr_find_c0a44246-c85b-407a-8dae-440075c5ae1a.ckpt</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:11.877609</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Restoring states from the checkpoint path at                                               <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
         <span style="color: #800080; text-decoration-color: #800080">/home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/</span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         <span style="color: #800080; text-decoration-color: #800080">coding_projects/P2_SVM/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">.lr_find_c0a44246-c85b-407a-8dae-440075c5ae1a.ckpt</span>                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Restored all states from the checkpoint at /home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/coding_projects/P2_SVM/.lr_find_c0a44246-c85b-407a-8dae-440075c5ae1a.ckpt</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:11.900391</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Restored all states from the checkpoint at                                                 <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">rank_zero.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning_utilities/core/rank_zero.py#63" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">63</span></a>
         <span style="color: #800080; text-decoration-color: #800080">/home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/notebooks/</span> <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
         <span style="color: #800080; text-decoration-color: #800080">coding_projects/P2_SVM/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">.lr_find_c0a44246-c85b-407a-8dae-440075c5ae1a.ckpt</span>                  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre>
</div>
</div>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> weight_decay_finder.plot(suggest<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>new_weight_decay <span class="op">=</span> weight_decay_finder.suggestion()</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>new_weight_decay, cls_task.hparams.weight_decay</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold">(</span><span class="ansi-cyan-fg ansi-bold">7.585775750291839e-05</span>, <span class="ansi-cyan-fg ansi-bold">7.585775750291839e-05</span><span class="ansi-bold">)</span></pre>
</div>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02svm_handy_crafted_linear_files/figure-html/cell-50-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>由于代码限制，第二张图中显示的learning rate其实是weight decay。</p>
<p>现在我们对调整后的参数进行重新训练</p>
<div id="cell-78" class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>cls_task <span class="op">=</span> get_cls_task()</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>cls_task.hparams.learning_rate <span class="op">=</span> new_lr</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>cls_task.hparams.weight_decay <span class="op">=</span> new_weight_decay</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: Seed set to 0</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:54:57.243884</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> Seed set to <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                                                                                   <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/utilities/seed.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">seed.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/utilities/seed.py#57" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">57</span></a>
</pre>
</div>
</div>
<div id="cell-79" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>trainer.fit(cls_task, datamodule<span class="op">=</span>cls_data)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>val_res_tuned <span class="op">=</span> trainer.validate(cls_task, datamodule<span class="op">=</span>cls_data)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>test_res_tuned <span class="op">=</span> trainer.test(cls_task, datamodule<span class="op">=</span>cls_data)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="cf">pass</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/plugins/environments/slurm.py:204: The `srun` command is available on your system but is not used. HINT: If your intention is to run Lightning on SLURM, prepend your python command with `srun` like so: srun python /home/ye_canming/program_files/managers/conda/envs/y ...
/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/model_checkpoint.py:654: Checkpoint directory /home/ye_canming/repos/assignments/THU-Coursework-Machine-Learning-for-Big-Data/runs/lightning_logs/version_16/checkpoints exists and is not empty.
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:01.204967</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: 
  | Name    | Type                | Params | Mode  | In sizes | Out sizes
-------------------------------------------------------------------------------
0 | model   | Linear              | 650    | train | [1, 64]  | [1, 10]  
1 | loss_fn | MultiClassHingeLoss | 0      | train | ?        | ?        
-------------------------------------------------------------------------------
650       Trainable params
0         Non-trainable params
650       Total params
0.003     Total estimated model params size (MB)
2         Modules in train mode
0         Modules in eval mode</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:01.224387</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span>                                                                                       <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/model_summary.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">model_summary.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/callbacks/model_summary.py#104" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">104</span></a>
           | Name    | Type                | Params | Mode  | In sizes | Out sizes             <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         -------------------------------------------------------------------------------       <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> | model   | Linear              | <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">650</span>    | train | <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">64</span><span style="font-weight: bold">]</span>  | <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span><span style="font-weight: bold">]</span>               <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> | loss_fn | MultiClassHingeLoss | <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>      | train | ?        | ?                     <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         -------------------------------------------------------------------------------       <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">650</span>       Trainable params                                                            <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>         Non-trainable params                                                        <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">650</span>       Total params                                                                <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.003</span>     Total estimated model params size <span style="font-weight: bold">(</span>MB<span style="font-weight: bold">)</span>                                      <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>         Modules in train mode                                                       <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>         Modules in eval mode                                                        <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                    </span>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d1704eed29934ff4919ff94078205cdf","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/loops/fit_loop.py:298: The number of training batches (11) is smaller than the logging interval Trainer(log_every_n_steps=50). Set a lower value for log_every_n_steps if you want to see logs for the training epoch.
/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/plugins/environments/slurm.py:204: The `srun` command is available on your system but is not used. HINT: If your intention is to run Lightning on SLURM, prepend your python command with `srun` like so: srun python /home/ye_canming/program_files/managers/conda/envs/y ...
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:03.645924</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"156156d9e8144f8ab4c049c6b8c9bbe1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">      Validate metric      </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         val_acc1          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.1319444477558136     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc10         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc2          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.2361111044883728     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc20         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc3          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.3541666567325592     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_acc5          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.5347222089767456     </span>│
│<span style="color: #008080; text-decoration-color: #008080">   val_balanced_accuracy   </span>│<span style="color: #800080; text-decoration-color: #800080">    0.13571429252624512    </span>│
│<span style="color: #008080; text-decoration-color: #008080">      val_cohen_kappa      </span>│<span style="color: #800080; text-decoration-color: #800080">    0.03511122986674309    </span>│
│<span style="color: #008080; text-decoration-color: #008080">          val_f1           </span>│<span style="color: #800080; text-decoration-color: #800080">    0.1358683854341507     </span>│
│<span style="color: #008080; text-decoration-color: #008080">      val_hinge_loss       </span>│<span style="color: #800080; text-decoration-color: #800080">    1.1006195545196533     </span>│
│<span style="color: #008080; text-decoration-color: #008080">       val_log_loss        </span>│<span style="color: #800080; text-decoration-color: #800080">    2.3971312046051025     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         val_loss          </span>│<span style="color: #800080; text-decoration-color: #800080">    204.75518798828125     </span>│
│<span style="color: #008080; text-decoration-color: #008080">   val_matthews_corrcoef   </span>│<span style="color: #800080; text-decoration-color: #800080">    0.03540673106908798    </span>│
│<span style="color: #008080; text-decoration-color: #008080">       val_precision       </span>│<span style="color: #800080; text-decoration-color: #800080">    0.13904762268066406    </span>│
│<span style="color: #008080; text-decoration-color: #008080">        val_recall         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.13571429252624512    </span>│
│<span style="color: #008080; text-decoration-color: #008080">        val_roc_auc        </span>│<span style="color: #800080; text-decoration-color: #800080">     0.544339656829834     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/fabric/plugins/environments/slurm.py:204: The `srun` command is available on your system but is not used. HINT: If your intention is to run Lightning on SLURM, prepend your python command with `srun` like so: srun python /home/ye_canming/program_files/managers/conda/envs/y ...
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0,1,2,3,4,5,6,7]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #7fbfbf; text-decoration-color: #7fbfbf">Sat 2024-11-16 00:58:04.947243</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #000080; text-decoration-color: #000080">INFO    </span> LOCAL_RANK: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> - CUDA_VISIBLE_DEVICES: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span><span style="font-weight: bold">]</span>                                         <a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">cuda.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///home/ye_canming/program_files/managers/conda/envs/yuequ/lib/python3.10/site-packages/lightning/pytorch/accelerators/cuda.py#61" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">61</span></a>
</pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"489abe4f6d784c95a0b91de099c59ca3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         test_acc1         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.11666666716337204    </span>│
│<span style="color: #008080; text-decoration-color: #008080">        test_acc10         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_acc2         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.25555557012557983    </span>│
│<span style="color: #008080; text-decoration-color: #008080">        test_acc20         </span>│<span style="color: #800080; text-decoration-color: #800080">            1.0            </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_acc3         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.3444444537162781     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_acc5         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.5166666507720947     </span>│
│<span style="color: #008080; text-decoration-color: #008080">  test_balanced_accuracy   </span>│<span style="color: #800080; text-decoration-color: #800080">    0.11671385914087296    </span>│
│<span style="color: #008080; text-decoration-color: #008080">     test_cohen_kappa      </span>│<span style="color: #800080; text-decoration-color: #800080">   0.018240757286548615    </span>│
│<span style="color: #008080; text-decoration-color: #008080">          test_f1          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.1174597293138504     </span>│
│<span style="color: #008080; text-decoration-color: #008080">      test_hinge_loss      </span>│<span style="color: #800080; text-decoration-color: #800080">    1.1020585298538208     </span>│
│<span style="color: #008080; text-decoration-color: #008080">       test_log_loss       </span>│<span style="color: #800080; text-decoration-color: #800080">     2.420191526412964     </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test_loss         </span>│<span style="color: #800080; text-decoration-color: #800080">     219.2089385986328     </span>│
│<span style="color: #008080; text-decoration-color: #008080">  test_matthews_corrcoef   </span>│<span style="color: #800080; text-decoration-color: #800080">   0.018393170088529587    </span>│
│<span style="color: #008080; text-decoration-color: #008080">      test_precision       </span>│<span style="color: #800080; text-decoration-color: #800080">    0.12187045812606812    </span>│
│<span style="color: #008080; text-decoration-color: #008080">        test_recall        </span>│<span style="color: #800080; text-decoration-color: #800080">    0.11671385914087296    </span>│
│<span style="color: #008080; text-decoration-color: #008080">       test_roc_auc        </span>│<span style="color: #800080; text-decoration-color: #800080">    0.5245167016983032     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div>
</div>
<div id="cell-80" class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>val_res <span class="op">=</span> val_res[<span class="dv">0</span>]</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>test_res <span class="op">=</span> test_res[<span class="dv">0</span>]</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>val_res_tuned <span class="op">=</span> val_res_tuned[<span class="dv">0</span>]</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>test_res_tuned <span class="op">=</span> test_res_tuned[<span class="dv">0</span>]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> val_res.keys():</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> val_res_tuned[key] <span class="op">-</span> val_res[key]</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    is_better <span class="op">=</span> delta<span class="op">&gt;</span><span class="dv">0</span> </span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'loss'</span> <span class="kw">in</span> key:</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>        is_better <span class="op">=</span> <span class="kw">not</span> is_better</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    results.append(<span class="bu">dict</span>(metric<span class="op">=</span>key, value<span class="op">=</span>val_res[key], tuned_value<span class="op">=</span>val_res_tuned[key], delta<span class="op">=</span>delta, is_better<span class="op">=</span>is_better))</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> test_res.keys():</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> test_res_tuned[key] <span class="op">-</span> test_res[key]</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    is_better <span class="op">=</span> delta<span class="op">&gt;</span><span class="dv">0</span> </span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'loss'</span> <span class="kw">in</span> key:</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>        is_better <span class="op">=</span> <span class="kw">not</span> is_better</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    results.append(<span class="bu">dict</span>(metric<span class="op">=</span>key, value<span class="op">=</span>test_res[key], tuned_value<span class="op">=</span>test_res_tuned[key], delta<span class="op">=</span>delta, is_better<span class="op">=</span>is_better))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(results)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">metric</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">tuned_value</th>
<th data-quarto-table-cell-role="th">delta</th>
<th data-quarto-table-cell-role="th">is_better</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>val_loss</td>
<td>263.031586</td>
<td>204.755188</td>
<td>-58.276398</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>val_acc1</td>
<td>0.854167</td>
<td>0.131944</td>
<td>-0.722222</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>val_acc2</td>
<td>0.951389</td>
<td>0.236111</td>
<td>-0.715278</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>val_acc3</td>
<td>0.965278</td>
<td>0.354167</td>
<td>-0.611111</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>val_acc5</td>
<td>0.979167</td>
<td>0.534722</td>
<td>-0.444444</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>val_acc10</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>val_acc20</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>val_matthews_corrcoef</td>
<td>0.842790</td>
<td>0.035407</td>
<td>-0.807383</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>val_f1</td>
<td>0.854586</td>
<td>0.135868</td>
<td>-0.718718</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>val_precision</td>
<td>0.883516</td>
<td>0.139048</td>
<td>-0.744469</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>val_recall</td>
<td>0.851905</td>
<td>0.135714</td>
<td>-0.716190</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>val_balanced_accuracy</td>
<td>0.851905</td>
<td>0.135714</td>
<td>-0.716190</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>val_cohen_kappa</td>
<td>0.837847</td>
<td>0.035111</td>
<td>-0.802735</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>val_roc_auc</td>
<td>0.975023</td>
<td>0.544340</td>
<td>-0.430684</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>val_hinge_loss</td>
<td>0.298429</td>
<td>1.100620</td>
<td>0.802190</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>val_log_loss</td>
<td>0.907206</td>
<td>2.397131</td>
<td>1.489925</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>test_loss</td>
<td>328.930206</td>
<td>219.208939</td>
<td>-109.721268</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>test_acc1</td>
<td>0.855556</td>
<td>0.116667</td>
<td>-0.738889</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>test_acc2</td>
<td>0.902778</td>
<td>0.255556</td>
<td>-0.647222</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>test_acc3</td>
<td>0.944444</td>
<td>0.344444</td>
<td>-0.600000</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>test_acc5</td>
<td>0.969444</td>
<td>0.516667</td>
<td>-0.452778</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>test_acc10</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>test_acc20</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>test_matthews_corrcoef</td>
<td>0.840778</td>
<td>0.018393</td>
<td>-0.822385</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>test_f1</td>
<td>0.851475</td>
<td>0.117460</td>
<td>-0.734016</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>test_precision</td>
<td>0.859034</td>
<td>0.121870</td>
<td>-0.737164</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>test_recall</td>
<td>0.853885</td>
<td>0.116714</td>
<td>-0.737171</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>test_balanced_accuracy</td>
<td>0.853885</td>
<td>0.116714</td>
<td>-0.737171</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>test_cohen_kappa</td>
<td>0.839472</td>
<td>0.018241</td>
<td>-0.821231</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>test_roc_auc</td>
<td>0.972230</td>
<td>0.524517</td>
<td>-0.447713</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>test_hinge_loss</td>
<td>0.300037</td>
<td>1.102059</td>
<td>0.802021</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>test_log_loss</td>
<td>1.314468</td>
<td>2.420192</td>
<td>1.105723</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>我们发现其实 <code>test_loss</code> 与 <code>val_loss</code> 其实我们调参之后的模型确实变小了，说明了调参的有效性。</p>
<p>但是其他所有指标，包括sklearn里面的<code>hinge_loss</code> (one vs all, 不是 crammer_singer，并且有对样本平均) 都变差了。这说明 crammer_singer 方法，或者”sum”而非”mean“的损失函数，是带有一定局限性的。</p>
</section>
<section id="附加题-对比不同-kernel-方法下的-svm-分类器-对完整svm进行调参" class="level3" data-number="0.19">
<h3 data-number="0.19" class="anchored" data-anchor-id="附加题-对比不同-kernel-方法下的-svm-分类器-对完整svm进行调参"><span class="header-section-number">0.19</span> 附加题: 对比不同 kernel 方法下的 SVM 分类器 （对完整SVM进行调参）</h3>
<p>现在我们手动实现了线性SVM，接下来我们对比不同 kernel 方法下的 SVM 分类器。</p>
<p>接下来的内容请见文件 <a href="./03svm_kernel_hpo.html">03svm_kernel_hpo</a>。</p>
<p>本次Project的目录请见绪论 <a href="./00svm.html">00svm</a>。</p>


</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/Open-Book-Studio\.github\.io\/THU-Coursework-Machine-Learning-for-Big-Data");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Open-Book-Studio/THU-Coursework-Machine-Learning-for-Big-Data/issues/new" class="toc-action"><i class="bi bi-github"></i>反馈问题</a></li></ul></div></div></div></footer></body></html>